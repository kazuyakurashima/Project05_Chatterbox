<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterbox</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ -->
    <div id="auth-container">
        <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="register-btn">æ–°è¦ç™»éŒ²</button>
        <button id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <!-- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¡¨ç¤º -->
        <div id="auth-status"></div>
    </div>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <div id="chat-container"> 
        <h1>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</h1>
        <!-- å„å ´æ‰€ã«idã‚’è¨­å®šã—ã¾ã—ã‚‡ã† -->
        <input type="text" id="uname" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        <textarea id="text" placeholder="æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
        <button id="send">é€ä¿¡</button>
        <div id="output"></div> <!-- ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module">

        // Firebase SDKã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } 
            from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
        import { getDatabase, ref, push, set, onChildAdded, remove } 
            from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

        // Your web app's Firebase configuration 
        const firebaseConfig = {
            apiKey:
        };

        // Firebaseã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Authenticationã®åˆæœŸåŒ–
        const db = getDatabase(app); // RealtimeDBã®åˆæœŸåŒ–
        const dbRef = ref(db, "chat"); // RealtimeDBå†…ã®"chat"ãƒãƒ¼ãƒ‰ã‚’å‚ç…§

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        document.getElementById("login-btn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:", userCredential.user);
                alert("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼");
            } catch (error) {
                console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error.message);
                alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + error.message);
            }
        });

        // æ–°è¦ç™»éŒ²å‡¦ç†
        document.getElementById("register-btn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æˆåŠŸ:", userCredential.user);
                alert("æ–°è¦ç™»éŒ²æˆåŠŸï¼");
            } catch (error) {
                console.error("æ–°è¦ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error.message);
                alert("æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + error.message);
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        document.getElementById("logout-btn").addEventListener("click", async () => {
            try {
                await signOut(auth);
                console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ");
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼");
            } catch (error) {
                console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", error.message);
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + error.message);
            }
        });

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
        onAuthStateChanged(auth, (user) => {
            const statusMessage = document.getElementById("auth-status"); // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ 
            const chatContainer = document.getElementById("chat-container"); // ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®å‡¦ç†
                console.log("ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:", user.email);
                statusMessage.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email}`;
                chatContainer.style.display = "block"; // ãƒãƒ£ãƒƒãƒˆã‚’è¡¨ç¤º
                // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
                document.getElementById("send").disabled = false; 
                document.getElementById("uname").disabled = false; 
                document.getElementById("text").disabled = false; 
            } else {
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã®å‡¦ç†
                console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã„ã¾ã™");
                statusMessage.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„";
                chatContainer.style.display = "none"; // ãƒãƒ£ãƒƒãƒˆã‚’éè¡¨ç¤º
            }
        });

        // ãƒ‡ãƒ¼ã‚¿é€ä¿¡
        $("#send").on("click", function() {
            const msg = {
                uname: $("#uname").val(),
                text: $("#text").val()
            };
            const newPostRef = push(dbRef); // æ–°ã—ã„ãƒãƒ¼ãƒ‰ã‚’ä½œæˆ
            set(newPostRef, msg); // ä½œæˆã—ãŸãƒãƒ¼ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜

            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            $("#uname").val("");
            $("#text").val("");
        });

        // ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«åæ˜ ï¼‰
        onChildAdded(dbRef, function(data) {
            const msg = data.val(); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’å–å¾—
            const key = data.key; // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’å–å¾—

            const h = `
            <div class="box">
                <p>${msg.uname}</p>
                <span class="remove" data-key="${key}">å‰Šé™¤ãƒœã‚¿ãƒ³ã ã‚ˆğŸ˜„</span>
                <p>${msg.text}</p>
            </div>
            `;
            $("#output").append(h); // è¡¨ç¤ºã‚¨ãƒªã‚¢ã«è¿½åŠ 
        });

        // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        $("#output").on("click", ".remove", function() {
            const key = $(this).attr("data-key"); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ã®ã‚­ãƒ¼ã‚’å–å¾—
            const removeItem = ref(db, "chat/" + key); // å‰Šé™¤å¯¾è±¡ã®å‚ç…§ã‚’å–å¾—

            remove(removeItem).then(() => {
                console.log("å‰Šé™¤æˆåŠŸ:", key);
                $(this).closest(".box").remove(); // ç”»é¢ã‹ã‚‰å‰Šé™¤
            }).catch(error => {
                console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
            });
        });
    </script>
</body>

</html>
